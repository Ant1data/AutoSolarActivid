name: Migrate Existing Video Artifacts

on:
	workflow_dispatch:
		inputs:
			dry_run:
				description: Only list artifacts without committing
				required: true
				default: 'true'
			max_artifacts:
				description: Limit number of artifacts processed (blank = all)
				required: false
				default: ''

jobs:
	migrate:
		runs-on: ubuntu-latest
		steps:
			- name: Checkout repository
				uses: actions/checkout@v4

			- name: Install gh CLI (already present)
				run: gh --version || echo 'gh installed'

			- name: List artifacts via API
				id: list
				env:
					GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
				run: |
					gh api repos/${{ github.repository }}/actions/artifacts --jq '.artifacts[] | {id: .id, name: .name, size: .size_in_bytes, expired: .expired}' > artifacts.json
					echo 'Artifacts saved to artifacts.json'
					cat artifacts.json | jq -s '.' > artifacts_full.json
					echo 'count='$(cat artifacts_full.json | jq 'length') >> $GITHUB_OUTPUT
					if [ -n "${{ inputs.max_artifacts }}" ]; then
						cat artifacts_full.json | jq ".[0:${{ inputs.max_artifacts }}]" > artifacts_limited.json
					else
						cp artifacts_full.json artifacts_limited.json
					fi
					echo 'Using list:'
					cat artifacts_limited.json

			- name: Download and extract artifacts
				if: steps.list.outputs.count != '0'
				env:
					GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
				run: |
					mkdir migrated
					i=0
					for id in $(cat artifacts_limited.json | jq -r '.[].id'); do
						echo "Downloading artifact $id"
						gh api repos/${{ github.repository }}/actions/artifacts/$id/zip > artifact_$id.zip || true
						unzip -o artifact_$id.zip -d migrated/artifact_$id || true
						i=$((i+1))
					done
					echo "Downloaded $i artifacts"

			- name: Move mp4 files into new tree
				run: |
					set -e
					mkdir -p solar_activity_videos/daily/manual_import
					mkdir -p solar_activity_videos/weekly/manual_import
					find migrated -type f -name '*.mp4' | while read f; do
						base=$(basename "$f")
						# Classify weekly vs daily by name patterns
						if echo "$base" | grep -qi 'weekly'; then
							target=solar_activity_videos/weekly/manual_import/$base
						else
							target=solar_activity_videos/daily/manual_import/$base
						fi
						cp "$f" "$target"
					done
					echo 'Files moved:'
					find solar_activity_videos -type f -name '*.mp4'

			- name: Commit migrated files (skip if dry_run)
				if: inputs.dry_run == 'false'
				run: |
					git config user.name 'github-actions[bot]'
					git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
					git add solar_activity_videos/daily/manual_import/*.mp4 || true
					git add solar_activity_videos/weekly/manual_import/*.mp4 || true
					git diff --cached --quiet || git commit -m 'Migrate historical video artifacts'
					git push

			- name: Summary
				run: |
					echo 'Migration workflow completed.'
					echo 'Dry run: ${{ inputs.dry_run }}'
